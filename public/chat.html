<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChatConnect - Global Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root {
      /* This CSS variable will be set by JavaScript to the actual visible height */
      --app-height: 100vh;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #18191c;
      /* Use the dynamic height variable */
      height: var(--app-height);
    }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #202225; }
    ::-webkit-scrollbar-thumb { background-color: #2f3136; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background-color: #3b3e44; }
    
    #chatBox {
      overscroll-behavior: contain;
    }

    @keyframes message-in {
      from { opacity: 0; transform: translateY(10px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .message-animate { animation: message-in 0.3s ease-out; }

    @keyframes typing-dot {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }
    .dot-1 { animation-delay: 0s; }
    .dot-2 { animation-delay: 0.1s; }
    .dot-3 { animation-delay: 0.2s; }

    @keyframes fade-out {
      from { opacity: 1; transform: scale(1); }
      to { opacity: 0; transform: scale(0.9); height: 0; padding: 0; margin: 0; }
    }
    .message-deleted {
      animation: fade-out 0.4s ease-out forwards;
    }

    #confirmationModal, #sidebarBackdrop, #profileModal {
        transition: opacity 0.3s ease;
    }

    #messageInput {
      resize: none; 
      max-height: 160px;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 #2f3136;
    }
    
    /* Style for the profile card's banner */
    .profile-banner {
        background-color: #1a1b1e;
        height: 80px;
    }
  </style>
</head>

<body class="text-gray-200 overflow-hidden flex flex-col">

<div class="flex flex-1 overflow-hidden">
  <!-- Server Icons Sidebar (Desktop only) -->
  <div class="hidden md:flex flex-col items-center w-16 bg-[#202225] p-2 space-y-3">
    <div class="relative w-12 h-12 flex items-center">
      <div class="absolute left-0 top-1/2 -translate-y-1/2 h-8 w-1 bg-white rounded-r-full"></div>
      <div id="serverIcon" class="w-12 h-12 flex items-center justify-center bg-blue-600 rounded-xl text-white font-bold text-xl cursor-pointer">
      </div>
    </div>
  </div>

  <!-- Users List & Profile Sidebar (Responsive) -->
  <div id="mobileSidebar" class="flex flex-col w-64 bg-[#2f3136] h-full absolute md:relative z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
    <header class="p-4 font-bold text-lg shadow-md flex justify-between items-center">
        <span>Online Users</span>
        <button id="closeSidebarBtn" class="md:hidden text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </header>
    <div id="userListContainer" class="flex-1 p-2 space-y-2 overflow-y-auto">
    </div>
    <div id="userProfile" class="p-3 bg-[#292b2f] flex items-center justify-between cursor-pointer hover:bg-gray-700/50 transition-colors">
    </div>
  </div>
  <div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col bg-[#36393f] min-w-0">
    <header class="flex items-center justify-between p-4 shadow-md flex-shrink-0">
      <div class="flex items-center">
        <button id="openSidebarBtn" class="md:hidden mr-3 text-gray-300 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <span class="text-gray-400 text-2xl mr-2">#</span>
        <h2 class="font-bold text-lg">global-chat</h2>
      </div>
    </header>
    
    <main id="chatBox" class="flex-1 p-4 overflow-y-auto space-y-4">
    </main>
    
    <footer class="p-4 flex-shrink-0">
      <div id="typingIndicator" class="h-6 text-sm text-gray-400 hidden items-center mb-1">
        <span id="typingUser" class="font-medium mr-1"></span>
        <span class="mr-2">is typing</span>
        <div class="flex space-x-1">
          <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-[typing-dot_1.2s_infinite] dot-1"></span>
          <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-[typing-dot_1.2s_infinite] dot-2"></span>
          <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-[typing-dot_1.2s_infinite] dot-3"></span>
        </div>
      </div>
      <div class="relative bg-[#40444b] rounded-xl p-1 pr-2 flex items-center">
        <textarea id="messageInput" rows="1" placeholder="Message #global-chat" class="w-full bg-transparent p-2 text-gray-200 placeholder-gray-500 focus:outline-none"></textarea>
        <button id="sendBtn" class="flex-shrink-0 ml-2 w-10 h-10 flex items-center justify-center bg-blue-600 text-white rounded-full transition-all duration-300 transform disabled:bg-gray-600 disabled:scale-100 disabled:shadow-none hover:scale-110 hover:shadow-lg hover:shadow-blue-600/50" disabled>
            <svg class="w-6 h-6 transform rotate-45 -mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
        </button>
      </div>
    </footer>
  </div>
</div>

<!-- NEW: Profile Modal -->
<div id="profileModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden opacity-0">
    <div class="bg-[#2f3136] rounded-lg shadow-xl w-full max-w-sm overflow-hidden relative">
        <button id="closeProfileBtn" class="absolute top-3 right-3 text-gray-400 hover:text-white z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <div class="profile-banner"></div>
        <div class="p-6 pt-0">
            <div class="relative -mt-12">
                <img id="profileModalAvatar" class="w-24 h-24 rounded-full border-4 border-[#2f3136] bg-gray-800" src="" alt="avatar">
            </div>
            <div class="mt-4">
                <h3 id="profileModalName" class="text-2xl font-bold text-white"></h3>
                <p id="profileModalEmail" class="text-sm text-gray-400"></p>
            </div>
             <div class="mt-6 pt-4 border-t border-gray-500/50">
                <h4 class="text-xs font-bold uppercase text-gray-400 mb-2">Status</h4>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="text-gray-300">Online</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-40 hidden opacity-0">
    <div class="bg-[#2f3136] rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h3 id="modalTitle" class="text-xl font-bold text-white mb-2">Delete Message</h3>
        <p id="modalText" class="text-gray-300 mb-6">Are you sure you want to permanently delete this message for everyone?</p>
        <div class="flex justify-center gap-4">
            <button id="cancelButton" class="px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-700 transition-colors">Cancel</button>
            <button id="confirmButton" class="px-6 py-2 rounded-md bg-red-600 hover:bg-red-700 transition-colors">Delete</button>
        </div>
    </div>
</div>

  <script>
    const setAppHeight = () => {
      document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
    };
    window.addEventListener('resize', setAppHeight);
    setAppHeight();
  </script>

  <script>
    const API_URL = "https://chatconnect-server.onrender.com";
    const token = localStorage.getItem("chatconnect_token");
    const user = JSON.parse(localStorage.getItem("chatconnect_user") || "{}");
    const onlineUsers = new Map();

    if (window.location.pathname.endsWith("chat.html")) {
      if (!token || !user.name) {
        window.location.href = "index.html";
      }

      const socket = io(API_URL, { auth: { token } });
      
      const chatBox = document.getElementById("chatBox");
      const sendBtn = document.getElementById("sendBtn");
      const messageInput = document.getElementById("messageInput");
      const userProfile = document.getElementById("userProfile");
      const typingIndicator = document.getElementById("typingIndicator");
      const typingUser = document.getElementById("typingUser");
      const userListContainer = document.getElementById("userListContainer");
      const serverIcon = document.getElementById("serverIcon");
      
      const modal = document.getElementById('confirmationModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalText = document.getElementById('modalText');
      const cancelButton = document.getElementById('cancelButton');
      const confirmButton = document.getElementById('confirmButton');
      
      const openSidebarBtn = document.getElementById('openSidebarBtn');
      const closeSidebarBtn = document.getElementById('closeSidebarBtn');
      const mobileSidebar = document.getElementById('mobileSidebar');
      const sidebarBackdrop = document.getElementById('sidebarBackdrop');

      // NEW: Profile Modal Elements
      const profileModal = document.getElementById('profileModal');
      const closeProfileBtn = document.getElementById('closeProfileBtn');
      const profileModalAvatar = document.getElementById('profileModalAvatar');
      const profileModalName = document.getElementById('profileModalName');
      const profileModalEmail = document.getElementById('profileModalEmail');

      let currentAction = null;
      let currentMessageId = null;
      
      const openSidebar = () => {
        mobileSidebar.classList.remove('-translate-x-full');
        sidebarBackdrop.classList.remove('hidden');
      };
      const closeSidebar = () => {
        mobileSidebar.classList.add('-translate-x-full');
        sidebarBackdrop.classList.add('hidden');
      };

      openSidebarBtn.addEventListener('click', openSidebar);
      closeSidebarBtn.addEventListener('click', closeSidebar);
      sidebarBackdrop.addEventListener('click', closeSidebar);

      // NEW: Profile Modal Logic
      const openProfileModal = () => {
        profileModalAvatar.src = `https://api.dicebear.com/8.x/adventurer/svg?seed=${user.name}&backgroundColor=transparent`;
        profileModalName.textContent = user.name;
        // Assuming email is derived from the username for this example
        profileModalEmail.textContent = `${user.name.toLowerCase().replace(/\s+/g, '.')}@chatconnect.app`;
        profileModal.classList.remove('hidden');
        setTimeout(() => profileModal.classList.remove('opacity-0'), 10);
      };

      const closeProfileModal = () => {
        profileModal.classList.add('opacity-0');
        setTimeout(() => profileModal.classList.add('hidden'), 300);
      };

      userProfile.addEventListener('click', openProfileModal);
      closeProfileBtn.addEventListener('click', closeProfileModal);
      profileModal.addEventListener('click', (e) => {
        if (e.target === profileModal) {
            closeProfileModal();
        }
      });

      if (user.name) {
        serverIcon.textContent = user.name.charAt(0).toUpperCase();
        onlineUsers.set(user.name, { status: 'online' });
        // Make the user profile section clickable and add hover effects
        userProfile.innerHTML = `<div class="flex items-center flex-grow min-w-0"><div class="relative"><img class="w-10 h-10 rounded-full" src="https://api.dicebear.com/8.x/adventurer/svg?seed=${user.name}&backgroundColor=transparent" alt="avatar"><div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-[#292b2f] rounded-full"></div></div><div class="ml-3 min-w-0"><p class="font-semibold text-white truncate">${user.name}</p><p class="text-xs text-gray-400">Online</p></div></div><button id="logoutBtn" class="p-2 rounded-full text-gray-400 hover:bg-gray-700/50 hover:text-white transition-colors flex-shrink-0" title="Logout"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0z"/><path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/></svg></button>`;
        const logoutBtn = document.getElementById("logoutBtn");
        logoutBtn.addEventListener("click", (e) => {
          e.stopPropagation(); // Prevents the profile modal from opening when logging out
          localStorage.removeItem("chatconnect_token");
          localStorage.removeItem("chatconnect_user");
          window.location.href = "index.html";
        });
      }
      
      function openModal(action, messageId) {
        currentAction = action;
        currentMessageId = messageId;
        if (action === 'delete-everyone') {
            modalTitle.textContent = 'Delete Message';
            modalText.textContent = 'Are you sure you want to permanently delete this message for everyone?';
            confirmButton.textContent = 'Delete';
            confirmButton.className = 'px-6 py-2 rounded-md bg-red-600 hover:bg-red-700 transition-colors';
        } else if (action === 'delete-local') {
            modalTitle.textContent = 'Remove Message';
            modalText.textContent = 'This will only remove the message from your view. Other people will still see it.';
            confirmButton.textContent = 'Remove';
            confirmButton.className = 'px-6 py-2 rounded-md bg-blue-600 hover:bg-blue-700 transition-colors';
        }
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
      }

      function closeModal() {
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
      }
      
      cancelButton.addEventListener('click', closeModal);
      confirmButton.addEventListener('click', () => {
        if (currentAction === 'delete-everyone') socket.emit('deleteMessage', { messageId: currentMessageId });
        else if (currentAction === 'delete-local') {
            const msg = document.getElementById(`message-${currentMessageId}`);
            if(msg) { msg.classList.add('message-deleted'); setTimeout(() => msg.remove(), 400); }
        }
        closeModal();
      });

      function updateUsersUI() {
        userListContainer.innerHTML = '';
        for (const username of onlineUsers.keys()) {
            const userElement = document.createElement('div');
            userElement.classList.add('flex', 'items-center', 'p-2', 'rounded-md', 'hover:bg-white/5', 'cursor-pointer');
            userElement.innerHTML = `<div class="relative"><img class="w-8 h-8 rounded-full" src="https://api.dicebear.com/8.x/adventurer/svg?seed=${username}&backgroundColor=transparent" alt="avatar"><div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-[#2f3136] rounded-full"></div></div><span class="ml-3 font-medium truncate">${username}</span>`;
            userListContainer.appendChild(userElement);
        }
      }

      function showLoadingSkeletons() {
        chatBox.innerHTML = Array(5).fill('<div class="flex items-start space-x-3 animate-pulse"><div class="w-10 h-10 bg-gray-600 rounded-full"></div><div class="flex-1 space-y-2"><div class="w-1/4 h-4 bg-gray-600 rounded"></div><div class="w-3/4 h-4 bg-gray-600 rounded"></div></div></div>').join('');
      }
      
      async function loadMessages() {
        showLoadingSkeletons();
        const res = await fetch(`${API_URL}/messages`, { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();
        chatBox.innerHTML = "";
        data.forEach(msg => {
            if (!onlineUsers.has(msg.username)) onlineUsers.set(msg.username, { status: 'online' });
            appendMessage(msg, false);
        });
        updateUsersUI();
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      
      function appendMessage(msg, isNew = true) {
        const { id, username: sender, text, timestamp } = msg;
        if (!onlineUsers.has(sender)) { onlineUsers.set(sender, { status: 'online' }); updateUsersUI(); }

        const isMe = sender === user.name;
        const messageElement = document.createElement("div");
        messageElement.setAttribute('id', `message-${id}`);
        messageElement.classList.add('flex', 'items-end', 'gap-2', 'w-full', 'group', isMe ? 'flex-row-reverse' : 'flex-row');
        if (isNew) messageElement.classList.add('message-animate');

        const formattedTime = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const avatarHTML = `<img class="w-10 h-10 rounded-full flex-shrink-0" src="https://api.dicebear.com/8.x/adventurer/svg?seed=${sender}&backgroundColor=transparent" alt="avatar">`;
        const bubbleHTML = `<div class="${isMe ? 'bg-blue-800' : 'bg-[#2f3136]'} p-3 rounded-lg text-white max-w-[80%]"><div class="flex items-baseline space-x-2"><span class="font-bold ${isMe ? 'hidden' : 'text-green-400'}">${sender}</span><span class="text-xs text-gray-400">${formattedTime}</span></div><p class="leading-relaxed break-words">${text}</p></div>`;
        const actionsHTML = `<div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">${isMe ? `<button data-message-id="${id}" data-action="delete-everyone" class="action-btn text-gray-500 hover:text-red-500 p-1 rounded-full" title="Delete for everyone"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>` : `<button data-message-id="${id}" data-action="delete-local" class="action-btn text-gray-500 hover:text-blue-400 p-1 rounded-full" title="Remove for me"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7 7 0 0 0-4.789 1.667l.708.708a6 6 0 0 1 4.08-1.588C12.482 3.48 15 8 15 8s-1.879 3.679-4.228 4.635l.707.707z"/><path d="M10.79 12.912l-1.614-1.615a3.5 3.5 0 0 0-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7 7 0 0 0 2.79-.588M5.21 3.088A7 7 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 3.327 3.327l-3.327-3.327zM2.887 5.525a3.5 3.5 0 0 1 4.474-4.474l-4.474 4.474zM1.679 1.163l13.162 13.162-1.414 1.415-13.162-13.162z"/></svg></button>`}</div>`;
        messageElement.innerHTML = `${avatarHTML}${bubbleHTML}${actionsHTML}`;

        chatBox.appendChild(messageElement);
        if (isNew) chatBox.scrollTop = chatBox.scrollHeight;
      }
      
      chatBox.addEventListener('click', (e) => {
        const actionButton = e.target.closest('.action-btn');
        if (actionButton) {
            const messageId = actionButton.dataset.messageId;
            const action = actionButton.dataset.action;
            openModal(action, messageId);
        }
      });

      socket.on("chatMessage", (msg) => {
        typingIndicator.classList.add('hidden');
        appendMessage(msg)
      });
      socket.on('messageDeleted', (messageId) => {
        const msg = document.getElementById(`message-${messageId}`);
        if (msg) { msg.classList.add('message-deleted'); setTimeout(() => msg.remove(), 400); }
      });
      
      function sendMessage() {
        const text = messageInput.value.trim();
        if (text !== "") {
          socket.emit("chatMessage", { text });
          socket.emit("typing-stopped");
          messageInput.value = "";
          messageInput.dispatchEvent(new Event('input'));
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });
      
      let typingTimer;
      const doneTypingInterval = 2000;

      messageInput.addEventListener('input', () => {
        sendBtn.disabled = messageInput.value.trim() === '';
        messageInput.style.height = 'auto';
        messageInput.style.height = (messageInput.scrollHeight) + 'px';

        clearTimeout(typingTimer);
        socket.emit('typing-started');
        typingTimer = setTimeout(() => {
            socket.emit('typing-stopped');
        }, doneTypingInterval);
      });

      let otherUserTypingTimer;
      socket.on('user-is-typing', (data) => {
        clearTimeout(otherUserTypingTimer);
        typingUser.textContent = data.username;
        typingIndicator.classList.remove('hidden');
        typingIndicator.classList.add('flex');
        otherUserTypingTimer = setTimeout(() => typingIndicator.classList.add('hidden'), 4000);
      });

      socket.on('user-stopped-typing', () => {
        clearTimeout(otherUserTypingTimer);
        typingIndicator.classList.add('hidden');
      });

      loadMessages();
    }
  </script>
</body>
</html>


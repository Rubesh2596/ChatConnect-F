<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChatConnect - Global Chat</title>
  <script src="https://cdn-tailwindcss.vercel.app/"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root {
      --app-height: 100vh;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #18191c;
      height: var(--app-height);
    }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #202225; }
    ::-webkit-scrollbar-thumb { background-color: #2f3136; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background-color: #3b3e44; }
    
    #chatBox {
      overscroll-behavior: contain;
    }

    @keyframes message-in {
      from { opacity: 0; transform: translateY(10px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .message-animate { animation: message-in 0.3s ease-out; }

    @keyframes typing-dot {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }
    .dot-1 { animation-delay: 0s; }
    .dot-2 { animation-delay: 0.1s; }
    .dot-3 { animation-delay: 0.2s; }

    @keyframes fade-out {
      from { opacity: 1; transform: scale(1); }
      to { opacity: 0; transform: scale(0.9); height: 0; padding: 0; margin: 0; }
    }
    .message-deleted {
      animation: fade-out 0.4s ease-out forwards;
    }

    #confirmationModal, #sidebarBackdrop, #profileModal {
        transition: opacity 0.3s ease;
    }

    #messageInput {
      resize: none; 
      max-height: 160px;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 #2f3136;
    }
    
    .profile-banner {
        background-color: #1a1b1e;
        height: 80px;
    }

    .popover {
        display: none;
        position: absolute;
        z-index: 10;
        transition: opacity 0.2s ease;
    }
    .message-content:hover .popover {
        display: flex;
    }
    .emoji-picker {
        display: none;
        position: absolute;
        z-index: 20; /* Higher than other popovers */
    }
    .reply-quote {
        border-left: 2px solid #4f545c;
        padding-left: 8px;
        margin-bottom: 6px;
        font-size: 0.875rem;
        background-color: rgba(0,0,0,0.1);
        border-radius: 4px;
        padding-top: 2px;
        padding-bottom: 2px;
    }
    .reply-quote p {
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
        display: -webkit-box;
    }
  </style>
</head>

<body class="text-gray-200 overflow-hidden flex flex-col">

<div class="flex flex-1 overflow-hidden">
  <!-- Server Icons Sidebar (Desktop only) -->
  <div class="hidden md:flex flex-col items-center w-16 bg-[#202225] p-2 space-y-3">
    <div class="relative w-12 h-12 flex items-center">
      <div class="absolute left-0 top-1/2 -translate-y-1/2 h-8 w-1 bg-white rounded-r-full"></div>
      <div id="serverIcon" class="w-12 h-12 flex items-center justify-center bg-blue-600 rounded-xl text-white font-bold text-xl cursor-pointer">
      </div>
    </div>
  </div>

  <!-- Users List & Profile Sidebar (Responsive) -->
  <div id="mobileSidebar" class="flex flex-col w-64 bg-[#2f3136] h-full absolute md:relative z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
    <header class="p-4 font-bold text-lg shadow-md flex justify-between items-center">
        <span>Online Users</span>
        <button id="closeSidebarBtn" class="md:hidden text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </header>
    <div id="userListContainer" class="flex-1 p-2 space-y-2 overflow-y-auto">
    </div>
    <div id="userProfile" class="p-3 bg-[#292b2f] flex items-center justify-between cursor-pointer hover:bg-gray-700/50 transition-colors">
    </div>
  </div>
  <div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col bg-[#36393f] min-w-0">
    <header class="flex items-center justify-between p-4 shadow-md flex-shrink-0">
      <div class="flex items-center">
        <button id="openSidebarBtn" class="md:hidden mr-3 text-gray-300 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <span class="text-gray-400 text-2xl mr-2">#</span>
        <h2 class="font-bold text-lg">global-chat</h2>
      </div>
    </header>
    
    <main id="chatBox" class="flex-1 p-4 overflow-y-auto space-y-4">
    </main>
    
    <footer class="p-4 flex-shrink-0">
      <div id="replyingToContainer" class="hidden items-center justify-between bg-[#2f3136] px-4 py-1.5 rounded-t-lg -mb-1">
        <div class="text-sm text-gray-300">
          Replying to <strong id="replyingToUser" class="text-white"></strong>
        </div>
        <button id="cancelReplyBtn" class="text-gray-400 hover:text-white">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <div id="typingIndicator" class="h-6 text-sm text-gray-400 hidden items-center mb-1">
        <span id="typingUser" class="font-medium mr-1"></span>
        <span class="mr-2">is typing</span>
        <div class="flex space-x-1">
          <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-[typing-dot_1.2s_infinite] dot-1"></span>
          <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-[typing-dot_1.2s_infinite] dot-2"></span>
          <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-[typing-dot_1.2s_infinite] dot-3"></span>
        </div>
      </div>
      <div id="messageInputContainer" class="relative bg-[#40444b] rounded-xl p-1 pr-2 flex items-center">
        <textarea id="messageInput" rows="1" placeholder="Message #global-chat" class="w-full bg-transparent p-2 text-gray-200 placeholder-gray-500 focus:outline-none"></textarea>
        <button id="sendBtn" class="flex-shrink-0 ml-2 w-10 h-10 flex items-center justify-center bg-blue-600 text-white rounded-full transition-all duration-300 transform disabled:bg-gray-600 disabled:scale-100 disabled:shadow-none hover:scale-110 hover:shadow-lg hover:shadow-blue-600/50" disabled>
            <svg class="w-6 h-6 transform rotate-45 -mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
        </button>
      </div>
    </footer>
  </div>
</div>

<!-- NEW: Emoji Picker Popover -->
<div id="emojiPicker" class="emoji-picker bg-[#202225] p-2 rounded-lg shadow-xl gap-2">
    <button class="emoji-option text-xl">üëç</button>
    <button class="emoji-option text-xl">‚ù§Ô∏è</button>
    <button class="emoji-option text-xl">üòÇ</button>
    <button class="emoji-option text-xl">üòÆ</button>
    <button class="emoji-option text-xl">üò¢</button>
    <button class="emoji-option text-xl">üôè</button>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden opacity-0">
    <div class="bg-[#2f3136] rounded-lg shadow-xl w-full max-w-sm overflow-hidden relative">
        <button id="closeProfileBtn" class="absolute top-3 right-3 text-gray-400 hover:text-white z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <div class="profile-banner"></div>
        <div class="p-6 pt-0">
            <div class="relative -mt-12">
                <img id="profileModalAvatar" class="w-24 h-24 rounded-full border-4 border-[#2f3136] bg-gray-800" src="" alt="avatar">
            </div>
            <div class="mt-4">
                <h3 id="profileModalName" class="text-2xl font-bold text-white"></h3>
                <p id="profileModalEmail" class="text-sm text-gray-400"></p>
            </div>
             <div class="mt-6 pt-4 border-t border-gray-500/50">
                <h4 class="text-xs font-bold uppercase text-gray-400 mb-2">Status</h4>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="text-gray-300">Online</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-40 hidden opacity-0">
    <div class="bg-[#2f3136] rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h3 id="modalTitle" class="text-xl font-bold text-white mb-2">Delete Message</h3>
        <p id="modalText" class="text-gray-300 mb-6">Are you sure you want to permanently delete this message for everyone?</p>
        <div class="flex justify-center gap-4">
            <button id="cancelButton" class="px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-700 transition-colors">Cancel</button>
            <button id="confirmButton" class="px-6 py-2 rounded-md bg-red-600 hover:bg-red-700 transition-colors">Delete</button>
        </div>
    </div>
</div>

  <script>
    const setAppHeight = () => {
      document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
    };
    window.addEventListener('resize', setAppHeight);
    setAppHeight();
  </script>

  <script>
    const API_URL = "https://chatconnect-server.onrender.com";
    const token = localStorage.getItem("chatconnect_token");
    const user = JSON.parse(localStorage.getItem("chatconnect_user") || "{}");
    const onlineUsers = new Map();

    if (window.location.pathname.endsWith("chat.html")) {
      if (!token || !user.name) {
        window.location.href = "index.html";
      }

      const socket = io(API_URL, { auth: { token } });
      
      const chatBox = document.getElementById("chatBox");
      const sendBtn = document.getElementById("sendBtn");
      const messageInput = document.getElementById("messageInput");
      const messageInputContainer = document.getElementById("messageInputContainer");
      const userProfile = document.getElementById("userProfile");
      const typingIndicator = document.getElementById("typingIndicator");
      const typingUser = document.getElementById("typingUser");
      const userListContainer = document.getElementById("userListContainer");
      const serverIcon = document.getElementById("serverIcon");
      const modal = document.getElementById('confirmationModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalText = document.getElementById('modalText');
      const cancelButton = document.getElementById('cancelButton');
      const confirmButton = document.getElementById('confirmButton');
      const openSidebarBtn = document.getElementById('openSidebarBtn');
      const closeSidebarBtn = document.getElementById('closeSidebarBtn');
      const mobileSidebar = document.getElementById('mobileSidebar');
      const sidebarBackdrop = document.getElementById('sidebarBackdrop');
      const profileModal = document.getElementById('profileModal');
      const closeProfileBtn = document.getElementById('closeProfileBtn');
      const profileModalAvatar = document.getElementById('profileModalAvatar');
      const profileModalName = document.getElementById('profileModalName');
      const profileModalEmail = document.getElementById('profileModalEmail');
      const replyingToContainer = document.getElementById('replyingToContainer');
      const replyingToUser = document.getElementById('replyingToUser');
      const cancelReplyBtn = document.getElementById('cancelReplyBtn');
      const emojiPicker = document.getElementById('emojiPicker');

      let currentAction = null;
      let currentMessageId = null;
      let replyToMessageId = null;
      let messageIdToReactTo = null; // NEW: Track which message is getting a reaction

      function appendMessage(msg, isNew = true) {
        const { id, username: sender, text, timestamp, reactions, originalMessage } = msg;
        if (!onlineUsers.has(sender)) { onlineUsers.set(sender, { status: 'online' }); updateUsersUI(); }

        const isMe = sender === user.name;
        const messageElement = document.createElement("div");
        messageElement.setAttribute('id', `message-${id}`);
        messageElement.classList.add('flex', 'items-start', 'gap-2', 'w-full', 'relative');
        if (isMe) messageElement.classList.add('flex-row-reverse');
        if (isNew) messageElement.classList.add('message-animate');

        const formattedTime = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const replyHTML = originalMessage ? `
            <div class="reply-quote">
                <strong>${originalMessage.username}</strong>
                <p class="text-gray-400">${originalMessage.text}</p>
            </div>
        ` : '';

        const popoverHTML = `
            <div class="popover absolute top-[-16px] ${isMe ? 'left-[-80px]' : 'right-[-80px]'} bg-[#202225] p-1 rounded-md shadow-lg gap-1">
                <button class="action-btn text-gray-300 hover:text-white p-1" title="Add Reaction" data-action="react" data-message-id="${id}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button class="action-btn text-gray-300 hover:text-white p-1" title="Reply" data-action="reply" data-message-id="${id}" data-username="${sender}">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                </button>
                ${isMe ? `<button class="action-btn text-gray-300 hover:text-red-500 p-1" title="Delete" data-action="delete-everyone" data-message-id="${id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>`: ''}
            </div>
        `;
        
        const avatarHTML = `<img class="w-10 h-10 rounded-full flex-shrink-0" src="https://api.dicebear.com/8.x/adventurer/svg?seed=${sender}&backgroundColor=transparent" alt="avatar">`;
        const bubbleHTML = `
            <div class="pb-4">
                <div class="${isMe ? 'bg-blue-800' : 'bg-[#2f3136]'} p-3 rounded-lg text-white max-w-md md:max-w-lg message-content relative group">
                    <div class="flex items-baseline space-x-2">
                        <span class="font-bold ${isMe ? 'hidden' : 'text-green-400'}">${sender}</span>
                        <span class="text-xs text-gray-400">${formattedTime}</span>
                    </div>
                    ${replyHTML}
                    <p class="leading-relaxed break-words">${text}</p>
                    ${popoverHTML}
                </div>
                <div class="reactions-container absolute bottom-[-10px] ${isMe ? 'right-12' : 'left-12'} flex gap-1"></div>
            </div>`;

        messageElement.innerHTML = `${avatarHTML}<div>${bubbleHTML}</div>`;
        chatBox.appendChild(messageElement);
        updateReactionsUI(id, reactions || []); // NEW: Call to render reactions
        if (isNew) chatBox.scrollTop = chatBox.scrollHeight;
      }

      function updateReactionsUI(messageId, reactions) {
        const msgElement = document.getElementById(messageId);
        if (!msgElement) return;

        const container = msgElement.querySelector('.reactions-container');
        if (!container) return;

        if (!reactions || reactions.length === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = [...new Set(reactions.map(r => r.emoji))].map(emoji => {
            const count = reactions.filter(r => r.emoji === emoji).length;
            const didIReact = reactions.some(r => r.emoji === emoji && r.userId === user.id);
            return `<button class="reaction-btn ${didIReact ? 'bg-blue-800' : 'bg-gray-700'} rounded-full px-2 py-0.5 text-xs flex items-center gap-1 hover:scale-110 transition-transform" data-message-id="${messageId}" data-emoji="${emoji}">
                <span>${emoji}</span>
                <span>${count}</span>
            </button>`
        }).join('');
      }

      chatBox.addEventListener('click', (e) => {
        const actionButton = e.target.closest('.action-btn');
        const reactionButton = e.target.closest('.reaction-btn');

        if (actionButton) {
            const messageId = actionButton.dataset.messageId;
            const action = actionButton.dataset.action;
            const username = actionButton.dataset.username;

            if (action === 'delete-everyone') {
                openModal(action, messageId);
            } else if (action === 'react') {
                messageIdToReactTo = messageId;
                const rect = actionButton.getBoundingClientRect();
                emojiPicker.style.display = 'flex';
                emojiPicker.style.top = `${rect.top - 50}px`;
                emojiPicker.style.left = `${rect.left - 80}px`;
            } else if (action === 'reply') {
                replyToMessageId = messageId;
                replyingToUser.textContent = username;
                replyingToContainer.classList.remove('hidden');
                replyingToContainer.classList.add('flex');
                messageInputContainer.classList.remove('rounded-xl');
                messageInputContainer.classList.add('rounded-b-xl');
                messageInput.focus();
            }
        }
        
        if (reactionButton) {
            const messageId = reactionButton.dataset.messageId;
            const emoji = reactionButton.dataset.emoji;
            socket.emit('reactToMessage', { messageId, emoji });
        }
      });
      
      emojiPicker.addEventListener('click', (e) => {
        const emojiButton = e.target.closest('.emoji-option');
        if (emojiButton && messageIdToReactTo) {
            const emoji = emojiButton.textContent;
            socket.emit('reactToMessage', { messageId: messageIdToReactTo, emoji });
            messageIdToReactTo = null;
            emojiPicker.style.display = 'none';
        }
      });

      document.body.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && !e.target.closest('[data-action="react"]')) {
            emojiPicker.style.display = 'none';
        }
      }, true);


      cancelReplyBtn.addEventListener('click', () => {
        replyToMessageId = null;
        replyingToContainer.classList.add('hidden');
        messageInputContainer.classList.add('rounded-xl');
        messageInputContainer.classList.remove('rounded-b-xl');
      });

      socket.on("chatMessage", (msg) => {
        typingIndicator.classList.add('hidden');
        appendMessage(msg)
      });

      socket.on('messageDeleted', (messageId) => {
        const msg = document.getElementById(`message-${messageId}`);
        if (msg) { msg.classList.add('message-deleted'); setTimeout(() => msg.remove(), 400); }
      });
      
      socket.on('messageReacted', ({ messageId, reactions }) => {
          updateReactionsUI(messageId, reactions);
      });
      
      function sendMessage() {
        const text = messageInput.value.trim();
        if (text !== "") {
          socket.emit("chatMessage", { text, replyTo: replyToMessageId });
          socket.emit("typing-stopped");
          messageInput.value = "";
          cancelReplyBtn.click();
          messageInput.dispatchEvent(new Event('input'));
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });
      
      let typingTimer;
      const doneTypingInterval = 2000;

      messageInput.addEventListener('input', () => {
        sendBtn.disabled = messageInput.value.trim() === '';
        messageInput.style.height = 'auto';
        messageInput.style.height = (messageInput.scrollHeight) + 'px';

        clearTimeout(typingTimer);
        socket.emit('typing-started');
        typingTimer = setTimeout(() => {
            socket.emit('typing-stopped');
        }, doneTypingInterval);
      });

      let otherUserTypingTimer;
      socket.on('user-is-typing', (data) => {
        clearTimeout(otherUserTypingTimer);
        typingUser.textContent = data.username;
        typingIndicator.classList.remove('hidden');
        typingIndicator.classList.add('flex');
        otherUserTypingTimer = setTimeout(() => typingIndicator.classList.add('hidden'), 4000);
      });

      socket.on('user-stopped-typing', () => {
        clearTimeout(otherUserTypingTimer);
        typingIndicator.classList.add('hidden');
      });

      async function loadMessages() {
        showLoadingSkeletons();
        const res = await fetch(`${API_URL}/messages`, { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();
        chatBox.innerHTML = "";
        data.forEach(msg => {
            if (!onlineUsers.has(msg.username)) onlineUsers.set(msg.username, { status: 'online' });
            appendMessage(msg, false);
        });
        updateUsersUI();
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      loadMessages();
      
      const openSidebar = () => { mobileSidebar.classList.remove('-translate-x-full'); sidebarBackdrop.classList.remove('hidden'); };
      const closeSidebar = () => { mobileSidebar.classList.add('-translate-x-full'); sidebarBackdrop.classList.add('hidden'); };
      openSidebarBtn.addEventListener('click', openSidebar);
      closeSidebarBtn.addEventListener('click', closeSidebar);
      sidebarBackdrop.addEventListener('click', closeSidebar);
      const openProfileModal = () => { profileModalAvatar.src = `https://api.dicebear.com/8.x/adventurer/svg?seed=${user.name}&backgroundColor=transparent`; profileModalName.textContent = user.name; profileModalEmail.textContent = `${user.name.toLowerCase().replace(/\s+/g, '.')}@chatconnect.app`; profileModal.classList.remove('hidden'); setTimeout(() => profileModal.classList.remove('opacity-0'), 10); };
      const closeProfileModal = () => { profileModal.classList.add('opacity-0'); setTimeout(() => profileModal.classList.add('hidden'), 300); };
      userProfile.addEventListener('click', openProfileModal);
      closeProfileBtn.addEventListener('click', closeProfileModal);
      profileModal.addEventListener('click', (e) => { if (e.target === profileModal) { closeProfileModal(); } });
      function openModal(action, messageId) { currentAction = action; currentMessageId = messageId; if (action === 'delete-everyone') { modalTitle.textContent = 'Delete Message'; modalText.textContent = 'Are you sure you want to permanently delete this message for everyone?'; confirmButton.textContent = 'Delete'; confirmButton.className = 'px-6 py-2 rounded-md bg-red-600 hover:bg-red-700 transition-colors'; } else if (action === 'delete-local') { modalTitle.textContent = 'Remove Message'; modalText.textContent = 'This will only remove the message from your view. Other people will still see it.'; confirmButton.textContent = 'Remove'; confirmButton.className = 'px-6 py-2 rounded-md bg-blue-600 hover:bg-blue-700 transition-colors'; } modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10); }
      function closeModal() { modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); }
      cancelButton.addEventListener('click', closeModal);
      confirmButton.addEventListener('click', () => { if (currentAction === 'delete-everyone') socket.emit('deleteMessage', { messageId: currentMessageId }); else if (currentAction === 'delete-local') { const msg = document.getElementById(`message-${currentMessageId}`); if(msg) { msg.classList.add('message-deleted'); setTimeout(() => msg.remove(), 400); } } closeModal(); });
      function updateUsersUI() { userListContainer.innerHTML = ''; for (const username of onlineUsers.keys()) { const userElement = document.createElement('div'); userElement.classList.add('flex', 'items-center', 'p-2', 'rounded-md', 'hover:bg-white/5', 'cursor-pointer'); userElement.innerHTML = `<div class="relative"><img class="w-8 h-8 rounded-full" src="https://api.dicebear.com/8.x/adventurer/svg?seed=${username}&backgroundColor=transparent" alt="avatar"><div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-[#2f3136] rounded-full"></div></div><span class="ml-3 font-medium truncate">${username}</span>`; userListContainer.appendChild(userElement); } }
      function showLoadingSkeletons() { chatBox.innerHTML = Array(5).fill('<div class="flex items-start space-x-3 animate-pulse"><div class="w-10 h-10 bg-gray-600 rounded-full"></div><div class="flex-1 space-y-2"><div class="w-1/4 h-4 bg-gray-600 rounded"></div><div class="w-3/4 h-4 bg-gray-600 rounded"></div></div></div>').join(''); }
    }
  </script>
</body>
</html>

